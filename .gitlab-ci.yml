# ---------------------------------------------------
# This section defines custom variables. 
# 
# Name                  Definition
# ----------------------------------------------------
# anansi_python_env     Stores stores the path to the 
#                       directory that contains the Python 
#                       virtual environment.
# ----------------------------------------------------
variables:
  python_venv_dir: "anansi_python_env" 
                                       
# ----------------------------------------------------
# This section defines stages of the pipeline:
#
#   prerequisite : Installs all dependent software, libraries, etc. 
#   build : Builds all project binaries
#   test : Runs all project tests
#   deploy : Deploys all project software.
#
# The prerequisite stage installs a python virtual environment and sphinx-doc.
# ----------------------------------------------------
stages:          # List of stages for jobs, and their order of execution
  - prequisites
  - build
  - test
  - deploy

# ----------------------------------------------------
# Jobs for the prerequisite stage.
# ----------------------------------------------------
#
# This job builds a python virtual environment and caches it
install-python-virtual-environment:
  stage: prequisites
  tags:
    - RuyLopez
  script:
    - echo 'This jobs builds the python virtual environment.'
    - python3 -m venv anansi_python_env
    - pip3 install -U sphinx
    - echo 'Python virtual environment successfully created.'
  cache:
    paths:
      - anansi_python_env/

# ---------------------------------
# Jobs for the build stage.
# ---------------------------------

build-job: # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - RuyLopez
  script:
    - echo "Compiling the code..."
    - echo "Compile complete."
  dependencies:
    - install-python-virtual-environment

# ----------------------------------------------------
# Jobs for the test stage.
# ----------------------------------------------------
unit-test-job:   
  stage: test
  tags: 
    - RuyLopez
  script:
    - echo "Running unit tests..."
    - sleep 10
    - echo "Code coverage is 90%"

lint-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  tags:
    - RuyLopez
  script:
    - echo "Linting code... This will take about 10 seconds."
    - sleep 10
    - echo "No lint issues found."

# ----------------------------------------------------
# Jobs for the deploy stage.
# ----------------------------------------------------

# This job deploys the project binaries.
deploy-job:
  stage: deploy
  tags:
    - RuyLopez
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."

# This deploys the documentation.
deploy-documentation : 
  stage : deploy
  tags :
    - RuyLopez
  script :
    - find . -name "sphinx-build"
    - echo 'source anansi_python_env/bin/activate'
    - echo 'Building documentation ...'
    - echo "sphinx-build --version"
    - tree -L 2
    - echo "Documentation sucessfully deployed."
